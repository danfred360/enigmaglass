<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Monitoring Apache Logs with Elastic | Enigma Glass Documentation</title> <meta name="generator" content="Jekyll v4.3.1" /> <meta property="og:title" content="Monitoring Apache Logs with Elastic" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Training materials and case studies for the Enigma Glass SIEM platform" /> <meta property="og:description" content="Training materials and case studies for the Enigma Glass SIEM platform" /> <link rel="canonical" href="http://localhost:4000/training/monitor_apache_logs/" /> <meta property="og:url" content="http://localhost:4000/training/monitor_apache_logs/" /> <meta property="og:site_name" content="Enigma Glass Documentation" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Monitoring Apache Logs with Elastic" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Training materials and case studies for the Enigma Glass SIEM platform","headline":"Monitoring Apache Logs with Elastic","url":"http://localhost:4000/training/monitor_apache_logs/"}</script> <!-- End Jekyll SEO tag --> <link rel="shortcut icon" type="image/png" href="/assets/favicon-32x32.png"> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Enigma Glass Documentation </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Training Materials category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/training/" class="nav-list-link">Training Materials</a><ul class="nav-list "><li class="nav-list-item "><a href="/training/elastic/" class="nav-list-link">The Elastic Stack</a></li><li class="nav-list-item "><a href="/training/components_of_siem/" class="nav-list-link">Components of SIEM</a></li><li class="nav-list-item active"><a href="/training/monitor_apache_logs/" class="nav-list-link active">Monitoring Apache Logs with Elastic</a></li><li class="nav-list-item "><a href="/training/additional_resources/" class="nav-list-link">Additional Resources</a></li></ul></li><li class="nav-list-item"><a href="/documentation/" class="nav-list-link">Documentation</a></li><li class="nav-list-item"><a href="/case-studies/" class="nav-list-link">Case Studies</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Enigma Glass Documentation" aria-label="Search Enigma Glass Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://www.enigmaglass.com/" class="site-button" target="_blank" rel="noopener noreferrer" > Enigma Glass Platform </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/training/">Training Materials</a></li> <li class="breadcrumb-nav-list-item"><span>Monitoring Apache Logs with Elastic</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="important-title no_toc" id="monitoring-apache-logs-with-elastic"> <a href="#monitoring-apache-logs-with-elastic" class="anchor-heading" aria-labelledby="monitoring-apache-logs-with-elastic"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Monitoring Apache Logs with Elastic </h1> <details open=""> <summary class="text-delta"> Table of contents </summary> <ol id="markdown-toc"> <li><a href="#overview" id="markdown-toc-overview">Overview</a></li> <li><a href="#environment" id="markdown-toc-environment">Environment</a></li> <li><a href="#see-it-in-action" id="markdown-toc-see-it-in-action">See it in action</a> <ol> <li><a href="#apache-access-log" id="markdown-toc-apache-access-log">Apache Access Log</a></li> <li><a href="#logging-agent-configuration" id="markdown-toc-logging-agent-configuration">Logging Agent Configuration</a></li> <li><a href="#generating-logs" id="markdown-toc-generating-logs">Generating Logs</a></li> <li><a href="#apache-log-event" id="markdown-toc-apache-log-event">Apache Log Event</a></li> <li><a href="#events-in-aggregate" id="markdown-toc-events-in-aggregate">Events in Aggregate</a></li> <li><a href="#visualising-data" id="markdown-toc-visualising-data">Visualising Data</a></li> <li><a href="#dashboards" id="markdown-toc-dashboards">Dashboards</a></li> <li><a href="#drilling-down" id="markdown-toc-drilling-down">Drilling Down</a></li> </ol> </li> <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li> </ol> </details> <h2 id="overview"> <a href="#overview" class="anchor-heading" aria-labelledby="overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview </h2> <p>SIEM solutions like Enigma Glass ingest all kinds of logs using small “agent” processes that run on devices. These agents can watch log files for changes, filter additions using software defined rules, and intelligently serve relevant data as json to a key-store index running somewhere else. The communication between the agents and the server can be TLS encrypted, which makes it possible to securely ingest logs from edge devices on entirely different networks.</p> <p>Agents are highly configurable and can be customized to support any application that logs to a file. For example, a web server running apache could be configured with an agent that watched the connection log. This connection log alone is enough data to create some really interesting visualizations and see some bad actors in action.</p> <p>The following training document outlines the key steps involved in analyzing logs that are generated by an Apache webserver in Elastic.</p> <h2 id="environment"> <a href="#environment" class="anchor-heading" aria-labelledby="environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Environment </h2> <dl> <dt>Linode</dt> <dd>Virtual Private Compute provider</dd> <dt>Ubuntu</dt> <dd>Server Operating System</dd> <dt>Apache2</dt> <dd>Webserver</dd> <dt>Logstash</dt> <dd>Log ingestion service - Elastic Product</dd> <dt>Elasticsearch</dt> <dd>Key store database that stores logs and elastic configuration - Elastic Product</dd> <dt>Kibana</dt> <dd>Frontend for Elasticsearch to visualize data - Elastic Product</dd> </dl> <h2 id="see-it-in-action"> <a href="#see-it-in-action" class="anchor-heading" aria-labelledby="see-it-in-action"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> See it in action </h2> <h3 id="apache-access-log"> <a href="#apache-access-log" class="anchor-heading" aria-labelledby="apache-access-log"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Apache Access Log </h3> <p>Below you can see the contents of the <code class="language-plaintext highlighter-rouge">access.log</code> file that is stored in logging directory of the Apache server. Every web request that the webserver receives is logged here as text. Each message contains a timestamp that can be used to index the log event.</p> <p><img src="./assets/apache-access-log.png" alt="Apache access.log file" /></p> <h3 id="logging-agent-configuration"> <a href="#logging-agent-configuration" class="anchor-heading" aria-labelledby="logging-agent-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Logging Agent Configuration </h3> <p>Logstash is Elastic’s data processing pipeline. It is one of many solutions for loading data into the Elastic server. Below is the contents of <code class="language-plaintext highlighter-rouge">/etc/logstash/conf.d/apache.conf</code> which stores the filtering rules that inform the pipeline on how to format the data in the json it’s sending to the Elastic server, and where to look for the logs. Note that we’re mapping the <code class="language-plaintext highlighter-rouge">clientip</code> field to the type <code class="language-plaintext highlighter-rouge">geoip</code> . This tells the Elastic server to take the ip address data from the log event and populate additional geo fields to add to the event json that can give us coordinates for the ip. You can read more about GeoIP in the Elastic Stack <a href="https://www.elastic.co/blog/geoip-in-the-elastic-stack">here</a>.</p> <p><img src="./assets/apache.conf.png" alt="apache.conf" /></p> <h3 id="generating-logs"> <a href="#generating-logs" class="anchor-heading" aria-labelledby="generating-logs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generating Logs </h3> <p>Now that Elastic is configured to ingest logs from our webserver we can generate a few logs by visiting the site in a browser. Here is what our simple website looks like:</p> <p><img src="./assets/website.png" alt="generating logs" /></p> <p>As you can see, our site is very basic. Our connection to the site is not encrypted with TLS. The only security measures that’ve been taken on the webserver are the configuration of a firewall and access hardening (only accept ssh keys and only allow ssh connections from my home network’s external IP address).</p> <h3 id="apache-log-event"> <a href="#apache-log-event" class="anchor-heading" aria-labelledby="apache-log-event"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Apache Log Event </h3> <p>This is a screenshot of a single apache log event in Kibana, which is Elastic’s visualisation layer. This table lists all the fields contained in the event json, which contains fields that are either populated by data that comes directly from the log file, or by data that is the product of a defined data processing pipeline. This makes it possible add an intermediary processing step that can use data from the log event to generate more related data to attatch to the event.</p> <p><img src="./assets/example-apache-log-event.png" alt="An example apache log event" /></p> <h3 id="events-in-aggregate"> <a href="#events-in-aggregate" class="anchor-heading" aria-labelledby="events-in-aggregate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Events in Aggregate </h3> <p>Below is a screenshot of Kibana’s Discover page with the apache logstash index pattern selected. From this view the user can search through the events using Elastic’s powerful querying language, or simply by clicking through events and adding filters through the user interface.</p> <p><img src="./assets/kibana-discover-view.png" alt="Apache log events in aggregate" /></p> <p>You might think that the only log events we should see here are the ones that were generated when we visited the site in the browser, but here we can see that there are already more requests from other external ip addresses. Who are these people?</p> <h3 id="visualising-data"> <a href="#visualising-data" class="anchor-heading" aria-labelledby="visualising-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Visualising Data </h3> <p>Data can be visualised in charts or graphs for aggregate analysis. Users can apply filters to the visualisations that change the scope of time and any other field in the event json.</p> <p>HTTP response status codes are returned by the webserver to the client to indicate whether the request has been completed sucessfully. The 5 major classes of status codes are:</p> <div class="table-wrapper"><table> <thead> <tr> <th style="text-align: left">Status Code</th> <th style="text-align: left">Class</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">100</code> - <code class="language-plaintext highlighter-rouge">199</code></td> <td style="text-align: left">Informational responses</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">200</code> - <code class="language-plaintext highlighter-rouge">299</code></td> <td style="text-align: left">Sucessful responses</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">300</code> - <code class="language-plaintext highlighter-rouge">399</code></td> <td style="text-align: left">Redirection messages</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">400</code> - <code class="language-plaintext highlighter-rouge">499</code></td> <td style="text-align: left">Client error responses</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">500</code> - <code class="language-plaintext highlighter-rouge">599</code></td> <td style="text-align: left">Server error responses</td> </tr> </tbody> </table></div> <p>Here you can see a pie chart displaying the different status codes that have been received by the server in the last 7 days. The webserver has been running for ~4 days at this point.</p> <p><img src="./assets/data-visualisation.png" alt="Data visualisation" /></p> <p>It looks like status code that is returned the most is <code class="language-plaintext highlighter-rouge">200</code>, followed pretty closely by <code class="language-plaintext highlighter-rouge">404</code>. Here’s what these codes mean:</p> <div class="table-wrapper"><table> <thead> <tr> <th style="text-align: left">Status Code</th> <th style="text-align: left">Meaning</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">200</code></td> <td style="text-align: left">OK - The meaning of this code depends on the HTTP method, but this generally means that the request was sucessful.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">400</code></td> <td style="text-align: left">Bad Request - The server is either incapable or unwilling to process the request due to a client error, like malformed syntax or deceptive request routing.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">404</code></td> <td style="text-align: left">Not Found - The server cannot find the requested resource; the page does not exist</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">408</code></td> <td style="text-align: left">Request Timeout - The server would like to close an idle connection.</td> </tr> </tbody> </table></div> <p>27.52% of the requests that our webserver has receive up until this point have returned “Not Found”. Whoever is making these requests seems to be trying to access a page that does not exists.</p> <p>Data visualizations can be a valuable tool when seeking to answer quick questions like “What are the most common HTTP methods that are used in our web requests?”</p> <p><img src="./assets/top-request-verbs.png" alt="Data visualisation" /></p> <p>The HTTP method that is used to make the request determines the action to be preformed on the resource that is identified by the path in the request url.</p> <div class="table-wrapper"><table> <thead> <tr> <th style="text-align: left">HTTP Method</th> <th style="text-align: left">Meaning</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">GET</code></td> <td style="text-align: left">Used to retrieve data from a specified resource in the webserver. This is the request that’s used when you visit a page in your browser.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">POST</code></td> <td style="text-align: left">Used to send data to the webserver to create or update a resource.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">CONNECT</code></td> <td style="text-align: left">Used to establish a tunnel to the server indentified by the URL.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">PRI</code></td> <td style="text-align: left">Used when the server receives a request that it is not set up to handle.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">HEAD</code></td> <td style="text-align: left">Used to retrieve the metadata that is associated with a URL without the message body in the response, which would contain the page content in a <code class="language-plaintext highlighter-rouge">GET</code> request.</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">OPTIONS</code></td> <td style="text-align: left">Used to retreive the the permitted communication options for a URL or server.</td> </tr> </tbody> </table></div> <p>We can use a treemap visualisation to take a look at the most common resources that are requested (using the path in the URL) for each response code that is returned for all <code class="language-plaintext highlighter-rouge">POST</code> requests the the webserver has recieved:</p> <p><img src="./assets/visualise-post-paths-by-response.png" alt="Post paths by response" /></p> <p>This visualisation was created by selecting the <code class="language-plaintext highlighter-rouge">response.keyword</code> and <code class="language-plaintext highlighter-rouge">request.keyword</code> fields to group by and filtering the log events to be passed to the visualisation to <code class="language-plaintext highlighter-rouge">POST</code> requests.</p> <p>We can see that the most frequently requested resource to <code class="language-plaintext highlighter-rouge">POST</code> to on our webserver has a path of <code class="language-plaintext highlighter-rouge">/boaform/admin/formLogin</code>. A quick Google search of this path yields <a href="https://www.theregister.com/2020/04/16/fiber_routers_under_fire/">this article</a> that suggests that what we might be seeing here is a botnet searching for vulnerable fiber optic routers.</p> <p>We can take a closer look at these requests in the Discover section with some filters:</p> <p><img src="./assets/boaform-discover.png" alt="Boaform discover" /></p> <h3 id="dashboards"> <a href="#dashboards" class="anchor-heading" aria-labelledby="dashboards"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dashboards </h3> <p>Data visualistaions can be collected in dashboards which allow users to see visualisations that can be made up of data from a variety of sources. Below is a screenshot of an example overview dashboard that a webmaster might user to monitor the perfomance of their apache server. <img src="./assets/webserver-dashboard.png" alt="Webmaster dashboard" /></p> <p>This dashboard contains a few interesting visualisations using geo data from the log events. <img src="./assets/webmaster-geo-dashboard.png" alt="Geo data dashboard" /></p> <h3 id="drilling-down"> <a href="#drilling-down" class="anchor-heading" aria-labelledby="drilling-down"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Drilling Down </h3> <p>In this screenshot example, the user has “drilled down” on the client country visualisation by selecting the United States. This dashboard was created to display various geo data, but by drlling down through the webmaster dashboard a filter has been applied that only populates the visualisations with events from the United States. <img src="./assets/geo-dashboard-drilldown.png" alt="Drill down dashboard" /></p> <p>This dashboard has been created to display information regarding post requests made to the server.</p> <p><img src="./assets/bad-actor-dashboard.png" alt="Drill down dashboard" /></p> <p>By selecting the part of the treemap that represents the 50% of requests that are targeting that boaform path, we can drill down into the geo data dashboard that we saw before with some filters applied to only show us log events that are associated with that path.</p> <p><img src="./assets/boaform-geo-drilldown.png" alt="Drill down dashboard" /></p> <h2 id="conclusion"> <a href="#conclusion" class="anchor-heading" aria-labelledby="conclusion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conclusion </h2> <p>This training document has outlined a high level overview of how log files can be analyzed using the Elastic stack. We were able to get an idea of what kind of requests our server is recieving using a combination of saved UI components and temporary queries and compenents that helped us visualise the log data and answer questions we had about the logs that we saw.</p> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Developed by IST 440W Group 2</p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
